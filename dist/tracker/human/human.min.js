/*
 *  tracking.js - v0.0.1
 *  Augmented Reality JavaScript Framework
 *  https://github.com/eduardolundgren/tracking.js/

 *  Copyright (c) 2013
 *  BSD License
 */(function(){tracking.type.HUMAN={NAME:"HUMAN",data:{},defaults:{blockSize:20,blockJump:2,blockScale:1.25,data:"frontal_face",minNeighborArea:.5},evalStage_:function(t,e,n,a,r,i,o,s){var c,u,l,h,f,m=this,d=m.defaults,g=t[1],v=t[2],p=v.length,y=0,A=1/(s*s),_=s/d.blockSize,E=a*i+r,w=a*i+(r+s),C=(a+s)*i+r,k=(a+s)*i+(r+s);for(u=e[E]-e[w]-e[C]+e[k],l=n[E]-n[w]-n[C]+n[k],h=u*A,f=l*A-h*h,f=f>1?Math.sqrt(f):1,c=0;p>c;c++){var b,U,M,F,D,x,R,I,L,V,q,N,S=v[c],O=S.length,z=S[O-3],H=S[O-2],T=S[O-1],G=0,j=(O-3)/5;for(b=0;j>b;b++)U=r+~~(S[5*b]*_),M=a+~~(S[5*b+1]*_),x=~~(S[5*b+2]*_),R=~~(S[5*b+3]*_),I=S[5*b+4],F=U+x,D=M+R,L=M*i+U,V=M*i+F,q=D*i+U,N=D*i+F,G+=(e[L]-e[V]-e[q]+e[N])*I;y+=z*f>G*A?H:T}return y>g},merge_:function(t){var e,n,a,r,i,o,s,c,u,l,h,f,m,d,g,v,p,y,A,_,E=this,w=E.defaults,C=w.minNeighborArea,k=t.length,b=new Uint32Array(k),U={};for(e=0;k>e;e++)if(!b[e])for(y=t[e],b[e]=1,U[e]={count:0,rect:y},a=y.x,r=y.y,i=y.size,o=a+i,s=r+i,n=e+1;k>n;n++)b[n]||(A=t[n],e!==n&&(c=A.x,u=A.y,f=A.size,l=c+f,h=u+f,m=Math.max(a,c),d=Math.max(r,u),g=Math.min(o,l),v=Math.min(s,h),p=(m-g)*(d-v),p/(i*i)>=C&&p/(f*f)>=C&&(_=U[e],b[n]=1,_.count++,i>f&&(_.rect=A))));var M=[];for(e in U)_=U[e],_.count>0&&M.push(_.rect);return M},track:function(t,e){var n,a,r=this,i=t[0],o=r.defaults,s=e.getVideoCanvasImageData(),c=e.canvas,u=c.get("height"),l=c.get("width"),h=new Uint32Array(l*u),f=new Uint32Array(l*u),m=0,d=r.data[i.data||o.data],g=d.length,v=0,p=0;c.forEach(s,function(t,e,n,r,i,o,s){a=~~(.299*t+.587*n+.114*e),0===o&0===s?(v=a,p=a*a):0===o?(v=a+h[o*l+(s-1)],p=a*a+f[o*l+(s-1)]):0===s?(v=a+h[(o-1)*l+s],p=a*a+f[(o-1)*l+s]):(v=a+h[o*l+(s-1)]+h[(o-1)*l+s]-h[(o-1)*l+(s-1)],p=a*a+f[o*l+(s-1)]+f[(o-1)*l+s]-f[(o-1)*l+(s-1)]),h[m]=v,f[m]=p,m++});for(var y,A,_=o.blockJump,E=o.blockScale,w=o.blockSize,C=Math.min(l,u),k=0,b=[];C>=w;w=~~(w*E))for(y=0;u-w>y;y+=_)for(A=0;l-w>A;A+=_){var U=!0;for(n=0;g>n;n++){var M=d[n];if(U=r.evalStage_(M,h,f,y,A,l,u,w),!U)break}U&&(b[k++]={size:w,x:A,y:y})}i.onFound&&i.onFound.call(e,r.merge_(b,e))}}})(window);