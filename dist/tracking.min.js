/*
 *  tracking.js - v0.0.1
 *  Augmented Reality JavaScript Framework
 *  https://github.com/eduardolundgren/tracking.js/

 *  Copyright (c) 2013
 *  BSD License
 */(function(t,e){var n=t.document,a=t.navigator,r=Object.prototype.hasOwnProperty,i=Array.prototype.slice,o={type:{},all:function(t,e){return Array.prototype.slice.call((e||n).querySelectorAll(t))},augment:function(t,e){function n(){e.apply(this,arguments),t.apply(this,arguments)}function a(){}return a.prototype=e.prototype,n.superclass=e.prototype,n.prototype=new a,n.prototype.constructor=n,o.merge(n.prototype,t.prototype),n},bind:function(t,n,a){var r=this;return a!==e&&(a=i.call(arguments,2)),function(o){return o!==e&&(o=i.call(arguments),a!==e&&(o=o.concat(a))),t.apply(n||r,o||a)}},forEach:function(t,e,n){var a;if(Array.isArray(t))t.forEach(function(){e.apply(n||this,arguments)});else for(a in t)r.call(t,a)&&e.call(n||t,t[a],a,t);return t},isNode:function(t){return t.nodeType||this.isWindow(t)},isString:function(t){return"string"==typeof t},isWindow:function(t){return!!(t&&t.alert&&t.document)},merge:function(t,e){var n;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t},one:function(t,e){var a=this;return a.isNode(t)?t:(e||n).querySelector(t)}};o.math={distance:function(t,e,n,a){var r=n-t,i=a-e;return Math.sqrt(r*r+i*i)}};var s=function(){var t=this;t.attrs_={}};s.prototype={attrs_:null,setAttrs:function(t,e){var n=this;o.forEach(t,function(t,a){e?n.attrs_[a]=t:n.set(a,t)})},set:function(t,e){var n=this,a=n[t+"Change_"];return n.attrs_[t]=e,a&&a.call(n,e,t),e},get:function(t){var e=this;return e.attrs_[t]},getAttrs:function(){var t=this;return t.attrs_},linkAttr:function(t,e,n){var a=this,r=t+"Change_",i=a[r];a[r]=function(n){i&&i.apply(this,arguments),e.set(t,n)},n&&e.set(t,a.get(t))}},o.Attribute=s;var c=function(t){var e=this;e.setAttrs(o.merge({height:240,visible:!0,width:320},t),!0)};c.prototype={domElement:null,heightChange_:function(t){var e=this;e.domElement.height=t},hide:function(){var t=this;return t.set("visible",!1),t},render:function(t){var e=this;return e.heightChange_(e.get("height")),e.visibleChange_(e.get("visible")),e.widthChange_(e.get("width")),o.one(t||n.body).appendChild(e.domElement),e},show:function(){var t=this;return t.set("visible",!0),t},visibleChange_:function(t){var e=this;e.domElement.style.display=t?"block":"none"},widthChange_:function(t){var e=this;e.domElement.width=t}},o.DomElement=o.augment(c,o.Attribute);var u=function(){var t=this;t.createCanvas_()};u.prototype={context:null,createCanvas_:function(){var t=this,e=n.createElement("canvas");t.domElement=e,t.context=e.getContext("2d")},getImageData:function(t,e,n,a){var r=this,i=t||0,o=e||0,s=n||r.get("width"),c=a||r.get("height");return r.context.getImageData(i,o,s,c)},setImageData:function(t,e,n){var a=this,r=e||0,i=n||0;return a.context.putImageData(t,r,i),a},forEach:function(t,e,n){var a,r=this,i=t.width,o=t.height,s=t.data,c=n||1,u=0,l=0;for(u=0;o>u;u+=c)for(l=0;i>l;l+=c)a=4*u*i+4*l,e.call(r,s[a],s[a+1],s[a+2],s[a+3],a,u,l,t)},loadImage:function(t,e,n,a,r,i){var o=this,s=n||0,c=a||0,u=r||o.get("width"),l=i||o.get("height"),m=o.context;if(m){var h=new Image;h.onload=function(){m.drawImage(h,s,c,u,l),e&&e.call(o),h=null},h.src=t}},toDataURL:function(t){var e=this;return e.domElement.toDataURL(t||"image/png")},transform:function(t){var e=this,n=e.getImageData(),a=n.data;return e.forEach(n,function(n,r,i,o,s){var c=t.apply(e,arguments);a[s]=c[0],a[s+1]=c[1],a[s+2]=c[2],a[s+3]=c[3]}),e.setImageData(n),e}},o.Canvas=o.augment(u,o.DomElement);var l=function(t){var e=this;e.setAttrs(o.merge({autoplay:!0,controls:!0},t),!0),e.trackers_={},e.createVideo_(),e.createCanvas_()};l.prototype={canvas:null,trackers_:null,createCanvas_:function(){var t=this;t.canvas=new o.Canvas,t.linkAttr("height",t.canvas,!0),t.linkAttr("width",t.canvas,!0)},createVideo_:function(){var t=this,e=t.get("autoplay"),a=n.createElement("video");a.autoplay=e,a.controls=t.get("controls"),t.domElement=a,e&&t.play()},getVideoCanvasImageData:function(){var t=this;return t.syncVideoCanvas(),t.canvas.getImageData()},load:function(){var t=this,e=t.domElement;return e.load.apply(e,arguments),t},loop_:function(){var t,e=this,n=e.trackers_;o.forEach(n,function(n,a){t=o.type[a],t.track&&t.track(n,e)}),Object.keys(n).length&&requestAnimationFrame(function(){e.loop_()})},pause:function(){var t=this,e=t.domElement;return e.pause.apply(e,arguments),t},play:function(){var t=this,e=t.domElement;return e.play.apply(e,arguments),t},renderVideoCanvas:function(t){var e=this;return e.syncVideoCanvas(),o.one(t||n.body).appendChild(e.canvas.domElement),e},srcChange_:function(t){var e=this;e.domElement.src=t},stopTracking:function(){var t=this;t.trackers_={}},syncVideoCanvas:function(){var t=this,e=t.domElement,n=t.get("width"),a=t.get("height");return e.readyState===e.HAVE_ENOUGH_DATA&&t.canvas.context.drawImage(t.domElement,0,0,n,a),t},toDataURL:function(t){var e=this;return e.syncVideoCanvas(),e.canvas.toDataURL(t)},track:function(t){var e=this,n=o.type[t.type.toUpperCase()],a=e.trackers_;if(!n)throw Error("A tracker type should be specified.");a[n.NAME]||(a[n.NAME]=[]),a[n.NAME].push(t),1===Object.keys(a).length&&e.loop_()}},o.Video=o.augment(l,o.DomElement);var m=function(t){var e=this;e.setAttrs(o.merge({audio:!0},t),!0),e.initUserMedia_()};m.prototype={initUserMedia_:function(){var t=this;a.getUserMedia(a.mozGetUserMedia?{video:!0}:{audio:t.get("audio"),video:!0},o.bind(t.defSuccessHandler_,t),o.bind(t.defErrorHandler_,t))},defSuccessHandler_:function(t){var e=this;try{e.set("src",URL.createObjectURL(t))}catch(n){e.set("src",t)}},defErrorHandler_:function(t){throw Error(t)}},o.VideoCamera=o.augment(m,o.Video),self.Int32Array||(self.Int32Array=Array,self.Float32Array=Array),self.Uint8ClampedArray||(self.Uint8ClampedArray=Array),t.URL||(t.URL=t.URL||t.webkitURL||t.msURL||t.oURL),a.getUserMedia||(a.getUserMedia=a.getUserMedia||a.webkitGetUserMedia||a.mozGetUserMedia||a.msGetUserMedia),function(){var e,n=0,a=["ms","moz","webkit","o"];for(e=0;a.length>e&&!t.requestAnimationFrame;++e)t.requestAnimationFrame=t[a[e]+"RequestAnimationFrame"],t.cancelAnimationFrame=t[a[e]+"CancelAnimationFrame"]||t[a[e]+"CancelRequestAnimationFrame"];t.requestAnimationFrame||(t.requestAnimationFrame=function(e){var a=(new Date).getTime(),r=Math.max(0,16-(a-n)),i=t.setTimeout(function(){e(a+r)},r);return n=a+r,i}),t.cancelAnimationFrame||(t.cancelAnimationFrame=function(t){clearTimeout(t)})}(),t.tracking=o})(window);